name: Build Godot Project

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  GODOT_VERSION: "4.6"
  PROJECT_NAME: "TTSim"

jobs:
  export:
    name: Export ${{ matrix.preset }}
    runs-on: ubuntu-latest
    container:
      image: barichello/godot-ci:4.6
    strategy:
      fail-fast: false
      matrix:
        include:
          - preset: "Windows Desktop"
            artifact: "TTSim-Windows"
            output: "build/windows/TTSim.exe"
            folder: "build/windows"
          - preset: "macOS"
            artifact: "TTSim-macOS"
            output: "build/macos/TTSim.zip"
            folder: "build/macos"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Setup export templates
        run: |
          mkdir -p ~/.local/share/godot/export_templates/
          mv /root/.local/share/godot/export_templates/${{ env.GODOT_VERSION }}.stable ~/.local/share/godot/export_templates/${{ env.GODOT_VERSION }}.stable

      - name: Setup export directory
        run: mkdir -p ${{ matrix.folder }}

      - name: Import project
        run: godot --headless --import

      - name: Export ${{ matrix.preset }}
        run: godot --headless --export-release "${{ matrix.preset }}" ${{ matrix.output }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: ${{ matrix.folder }}/
          retention-days: 14
